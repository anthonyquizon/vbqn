#! /usr/bin/env bqn

runtime â† â€¢Import "_extern/bqn/rt.bqn"     # Runtime: primitives available to VM
gl      â† â€¢Import "_extern/bqn/src/glyphs.bqn"

#compile â† gl â€¢Import "src/compiler.bqn"  # Compiler: source â†’ object code
compile â† gl â€¢Import "src/compiler0.bqn"  # Compiler: source â†’ object code
vm      â†    â€¢Import "_extern/bqn/vm.bqn"     # VM: interprets object code

# TODO map â€¢FFI to  bqns FFI

# Define system values later, to include BQN
#BQN â† âŸ¨runtime, {System ğ•©}âŸ© âŠ¸ (Compile)
BQN â† {âŸ¨ğ•¨, runtime, { System ğ•© }âŸ© (VM Compile) ğ•©}

#âŒœ
# System values
IsPrim â† âˆŠâŸœruntimeâŒ¾<
Glyph â† runtimeâŠ¸âŠâŒ¾<âŠ‘(âˆ¾gl)Ë™
Decompose â† IsPrimâ—¶âŸ¨â€¢Decompose,0âŠ¸â‰âŸ©

# Formatter
tn â† "*"âŠ¸(âˆ¾âˆ¾âŠ£)Â¨"array"â€¿"function"â€¿"1-modifier"â€¿"2-modifier"â€¿"namespace"
Fmtâ€¿Repr â† (â€¢Import "_extern/bqn/src/f.bqn"){ğ”½} âŸ¨
  â€¢Type
  Decompose
  IsPrimâ—¶âŸ¨tnâŠ‘Ëœâ€¢Type-2Ë™, GlyphâŸ© # Format operation/namespace
  â€¢Repr                        # Format number
âŸ©
Show â† â€¢Outâˆ˜FmtâŠ¸âŠ¢âŠ¢

#âŒœ
# Evaluate
Evalâ†{
  0 < â‰ ğ•© ?
    t â† âŠ‘ "-e"â€¿"-p" âŠ âŠğ•©
    # TODO add args
    fâ†0âŠ‘ğ•©
    dirâ†f/ËœÂ¬+`'/'=f
    #â€¢Show t
    {dirâ‡dir} BQN â€¢file.Chars 0âŠ‘ğ•©
    #â€¢Show â€¢file.Chars 0âŠ‘ğ•©
    #ShowâŸ(t=1)âˆ˜BQNÂ¨ (t<2)â—¶âŸ¨â€¢file.CharsÂ¨, 1âŠ¸â†“âŸ© ğ•©
    #ğ•©
    #ShowâŸ(t=1)âˆ˜BQNÂ¨ (t<2)â—¶âŸ¨â€¢file.CharsÂ¨, 1âŠ¸â†“âŸ© ğ•©
}

Import â† {
  pathâ†ğ•¨.dirâˆ¾'/'âˆ¾ğ•©
  Eval âŸ¨pathâŸ©
}

# Lookup table
sys_namesâ†âŸ¨
  "bqn"â€¿"type"â€¿"glyph"â€¿"decompose"â€¿"repr"â€¿"fmt"â€¿"out"â€¿"show"â€¿"import"
   BQN â€¿â€¢Type â€¿ Glyph â€¿ Decompose â€¿ Repr â€¿ Fmt â€¿â€¢Out â€¿ Show â€¿ Import
âŸ©

FindSys â† {
  i â† ğ•¨âŠğ•©
  { ! âˆ¾âŸ¨"Unknown system value",(1â‰ â‰ ğ•©)/"s",":"âŸ©âˆ¾" â€¢"âŠ¸âˆ¾Â¨ğ•© }âˆ˜/âŸœğ•©âŸ(âˆ¨Â´) i=â‰ ğ•¨
  i
}
System â† {
  fâ†{
    #â€¢Show ğ•©
    #â€¢Show ğ•¨
      ğ•¨âŠ¸FindSysâŠğ•©Ë™
    }Â´sys_names
  #â€¢Show ğ•¨ F ğ•©
  ğ•¨ F ğ•©
}


Eval â€¢args

BQN  # Return the evaluator so it can be â€¢Include d from BQN
