#! /usr/bin/env bqn

runtime â† â€¢Import "_extern/bqn/rt.bqn"     # Runtime: primitives available to VM
gl      â† â€¢Import "_extern/bqn/src/glyphs.bqn"

#compile  â† gl â€¢Import "src/compiler.bqn"  # Compiler: source â†’ object code
compile  â† gl â€¢Import "_extern/bqn/src/c.bqn"     # 
vm      â†    â€¢Import "src/vm.bqn"     # VM: interprets object code

# TODO map â€¢FFI to  bqns FFI

#BQN â† âŸ¨runtime, {System ğ•©}âŸ© âŠ¸ (Compile)
BQN â† {
  dir ğ•Š src:
    outâ†âŸ¨runtime, { System ğ•© }âŸ© Compile src
    dirâ€¿srcâ€¿âŸ¨"foo.bqn:2"âŸ© VM out
}

#âŒœ
# System values
IsPrim â† âˆŠâŸœruntimeâŒ¾<
Glyph â† runtimeâŠ¸âŠâŒ¾<âŠ‘(âˆ¾gl)Ë™
Decompose â† IsPrimâ—¶âŸ¨â€¢Decompose,0âŠ¸â‰âŸ©

# Formatter
tn â† "*"âŠ¸(âˆ¾âˆ¾âŠ£)Â¨"array"â€¿"function"â€¿"1-modifier"â€¿"2-modifier"â€¿"namespace"
Fmtâ€¿Repr â† (â€¢Import "_extern/bqn/src/f.bqn"){ğ”½} âŸ¨
  â€¢Type
  Decompose
  IsPrimâ—¶âŸ¨tnâŠ‘Ëœâ€¢Type-2Ë™, GlyphâŸ© # Format operation/namespace
  â€¢Repr                        # Format number
âŸ©
Show â† â€¢Outâˆ˜FmtâŠ¸âŠ¢âŠ¢

#âŒœ
# Evaluate
Evalâ†{
  0 < â‰ ğ•© ?
    t â† âŠ‘ "-e"â€¿"-p" âŠ âŠğ•©
    fâ†0âŠ‘ğ•©
    dirâ†f/ËœÂ¬+`'/'=f
    dir BQN â€¢file.Chars 0âŠ‘ğ•©
}

# TODO defer import
Import â† {
  # TODO add args
  Eval âŸ¨ğ•¨.dirâˆ¾'/'âˆ¾ğ•©âŸ©
}

# Lookup table
systableâ†âŸ¨
  "bqn"â€¿"type"â€¿"glyph"â€¿"decompose"â€¿"repr"â€¿"fmt"â€¿"out"â€¿"show"â€¿"import"
   BQN â€¿â€¢Type â€¿ Glyph â€¿ Decompose â€¿ Repr â€¿ Fmt â€¿â€¢Out â€¿ Show â€¿ Import
âŸ©

  # Lookup table
FindSys â† {
  i â† ğ•¨âŠğ•©
  { ! âˆ¾âŸ¨"Unknown system value",(1â‰ â‰ ğ•©)/"s",":"âŸ©âˆ¾" â€¢"âŠ¸âˆ¾Â¨ğ•© }âˆ˜/âŸœğ•©âŸ(âˆ¨Â´) i=â‰ ğ•¨
  i
}
system â† {ğ•¨âŠ¸FindSysâŠğ•©Ë™}Â´systable

Eval â€¢args

BQN  # Return the evaluator so it can be â€¢Include d from BQN
