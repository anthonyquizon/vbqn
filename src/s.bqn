âŸ¨âŸ¨FmtâŸ©â‡strings, âŸ¨UpdateâŸ©â‡hashmapâŸ©â†â€¢Import "util.bqn"
lfâ†@+10

# data map

idm   â‡ âŸ¨âŸ© â€¢HashMap âŸ¨âŸ©
linm  â‡ âŸ¨âŸ© â€¢HashMap âŸ¨âŸ© # file -> bytcode to lines 
colm  â‡ âŸ¨âŸ© â€¢HashMap âŸ¨âŸ© # file -> bytcode to lines

MakeStack â† {
  s â† ğ•©                          # Stack (a list)
  Push â‡ {sâˆ¾â†©<ğ•© â‹„ ğ•©}                 # Push a value
  Pop  â‡ {tâ†-ğ•© â‹„ (sâ†“Ëœâ†©t) âŠ¢ âŒ½tâ†‘s} # Pop ğ•© values; return as list
  Peek â‡ {ğ•Š: 0=â‰ s ? âŸ¨âŸ©;Â¯1âŠ‘s}                # Return but don't pop top value
}

# i32:c8 â†’ i32: the c data type that is converted to and c8: the bqn data type that is converted from
sqlâ‡{
  sqlite_init_c  â† "../lib.so" â€¢FFI "u64"â€¿"sqlite_init"â€¿"*u8:c8"
  sqlite_exec_c  â† "../lib.so" â€¢FFI "u64"â€¿"sqlite_exec"â€¿"*u32:c32"
  sqlite_close_c â† "../lib.so" â€¢FFI ""â€¿"sqlite_close"

  Init  â‡ { Sqlite_init_c âŸ¨ğ•©âˆ¾@+0âŸ© }
  Exec  â‡ { Sqlite_exec_c âŸ¨ğ•©âˆ¾@+0âŸ© }
  Close â‡ { ğ•Š: Sqlite_close_c âŸ¨âŸ© }

  Setup â‡ { ğ•Š:
    â€¢SH "rm"â€¿"-r"â€¿"_data/db" 
    Init "_data/db"
    Exec â€¢FChars "tables.sql"
  }
}

ctx â‡ {
  s â‡ MakeStack âŸ¨âŸ©

  Push â‡ {
    fâ†ğ•©âˆ¾Ëœ(0âŠ¸â‰¢â‰ )â—¶""â€¿âŠ‘ s.Peek @
    s.Push {cwdâ‡â€¢file.Parent f, srcâ‡â€¢file.Chars "../"âˆ¾f, fileâ‡f}
  }

  Peek â‡ s.Peek
  Pop  â‡ s.Pop
}

# Rename?
SetFileLocâ‡{
  ğ•Š loc:
    âŸ¨src,fileâŸ©â†ctx.Peek @
    file colm.Set âˆ¾+`Â¨1Â¨Â¨âŠ”+`src=lf
    file linm.Set 1++`src=lf # convert locs to line numbers
}

bodies â‡ {
  sâ‡ MakeStack âŸ¨âŸ©
  c â‡ 0

  Pushâ‡{
    startâ€¿Â·â†ğ•©
      âŸ¨src,fileâŸ© â†ctx.Peek @
      idâ†idmâ€¿(startâˆ¾âŸ¨fileâŸ©) Update (idm.Count @)
      c +âŸœ1â†©

      sql.Exec "insert into bodies(id, start, file) values ({}, {}, '{}')" Fmt idâ€¿startâ€¿file
      # TODO add history
      s.Push id
  }

  Popâ‡{ ğ•Š: (âŠ‘s.Pop 1) }

  Regâ‡{ name ğ•Š iâ€¿Â·:
    âŸ¨fileâŸ©â†ctx.Peek @ 
    idâ†s.Peek @ â‹„ lâ†iâŠ‘linm.Get file â‹„ câ†iâŠ‘colm.Get file  
    
    sql.Exec "insert into regs(body, name, line, col) values ({}, '{}', {}, {})" Fmt idâ€¿nameâ€¿lâ€¿c

  }
}
