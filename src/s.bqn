
cm      â‡ âŸ¨âŸ© â€¢HashMap âŸ¨âŸ© # count of each function call
vm      â‡ âŸ¨âŸ© â€¢HashMap âŸ¨âŸ© # variables and arguments
idm     â‡ âŸ¨âŸ© â€¢HashMap âŸ¨âŸ©
outm    â‡ âŸ¨âŸ© â€¢HashMap âŸ¨âŸ©
history â‡ âŸ¨âŸ©

MakeStack â† {
  s â† ğ•©                          # Stack (a list)
  Push â‡ {sâˆ¾â†©<ğ•© â‹„ ğ•©}                 # Push a value
  Pop  â‡ {tâ†-ğ•© â‹„ (sâ†“Ëœâ†©t) âŠ¢ âŒ½tâ†‘s} # Pop ğ•© values; return as list
  Peek â‡ {ğ•Š: 0=â‰ s ? âŸ¨âŸ©;Â¯1âŠ‘s}                # Return but don't pop top value
}

ctx â‡ {
  s â‡ MakeStack âŸ¨âŸ©

  Push â‡ {
    fâ†ğ•©âˆ¾Ëœ(0âŠ¸â‰¢â‰ )â—¶""â€¿âŠ‘ s.Peek @
    s.Push âŸ¨â€¢file.Parent "../"âˆ¾f, â€¢file.Chars "../"âˆ¾f, fâŸ©
  }

  Peek â‡ s.Peek
  Pop  â‡ s.Pop
}

# Hash: startâ€¿filenameâ€¿c
bodies â‡ {
  sâ‡ MakeStack âŸ¨âŸ©

  Pushâ‡{
    startâ€¿argsâ†ğ•©
      âŸ¨Â·,Â·,fileâŸ© â†ctx.Peek @
      i â† startâˆ¾âŸ¨fileâŸ©
      j  â† cm.Hasâ—¶{ğ•© cm.Set 0 â‹„ 0}â€¿cm.Get i
      i cm.Set j+1
      id â† (idm.Count @)
      (iâˆ¾j) idm.Set id

      history âˆ¾âŸœ(âŸ¨idâŸ©)â†©
      s.Push id
  }

  Popâ‡{ (âŠ‘s.Pop 1) outm.Set ğ•© }

  Recâ‡{
    id â†s.Peek @
    (idâˆ¾ğ•¨) vm.Set ğ•©
  }
}

# i32:c8 â†’ i32: the c data type that is converted to and c8: the bqn data type that is converted from
sqlâ‡{
  sqlite_init_c  â† "../lib.so" â€¢FFI "u64"â€¿"sqlite_init"â€¿"*u8:c8"
  sqlite_exec_c  â† "../lib.so" â€¢FFI "u64"â€¿"sqlite_exec"â€¿"*u8:c8"
  sqlite_close_c â† "../lib.so" â€¢FFI ""â€¿"sqlite_close"

  Init  â‡ { Sqlite_init_c âŸ¨ğ•©âˆ¾@+0âŸ© }
  Exec  â‡ { Sqlite_exec_c âŸ¨ğ•©âˆ¾@+0âŸ© }
  Close â‡ { ğ•Š: Sqlite_close_c âŸ¨âŸ© }
  Populate â‡ { ğ•Š:
    "v"â€¿"out"â€¿"idm"{â€¢Show ğ•¨ â‹„ â€¢Show >(ğ•©.Keys @)â€¿(ğ•©.Values @)}Â¨vmâ€¿outmâ€¿idm
    â€¢Show history
    â€¢Show "--"

    â€¢SHow â€¢FChars "tables.sql"
    sql.Init "db"
    #sql.Exec "create table if not exists foo (a string, b int, c double)"
    #sql.Exec "
      #insert into foo (a, b, c) values ('foo', 222, 1.2);
      #insert into foo (a, b, c) values ('foo', 999, 1.2);
      #insert into foo (a, b, c) values ('foo', 0, 1.2);
      #insert into foo (a, b, c) values ('foo', 123, 1.2);
      #insert into foo (a, b, c) values ('foo', 223, 1.2);

    #"

    filesâ†â·1âŠ¸âŠ‘Â¨idm.Keys @
    varsâ†1âŠ‘Â¨vm.Keys @
    valsâ†vm.Values @

    â€¢SHow "foo"âŠ¸â·Â¨files

    #â€¢Show vals/Ëœvars='ğ•©'âˆ§file=''
    # order by history
    # (vars=a)âˆ§(file="foo*")
  }
}


