funcâ€¿mod1â€¿mod2 â† â€¢args
naâ†Â¯1âŠ‘â‰¢alphâ†("aA"+âŒœâ†•26)âˆ¾Ë˜"Ã Ã€"+âŒœ(â†•23)âˆ¾24+â†•7
lfâ†@+10â€¿13
charSetâ€¿cglâ†(âˆ¾ â‹ˆ â‰ Â¨)âŸ¨
  func                  # Function
  mod1                  # 1-modifier
  mod2                  # 2-modifier
  "â‹„,"âˆ¾lf               # Separator
  ":;?"                 # Header punctuation
  "â‡â†â†©"                 # Gets
  "(){}âŸ¨âŸ©[]"            # Bracket
  "â€¿"                   # Ligature
  "Â·"                   # nOthing
  # Use last character in case of UTF-16 (like dzaima/BQN)
  Â¯1âŠË˜11â€¿âˆ˜â¥Š"ğ•Šğ•ğ•ğ”½ğ”¾ğ•¤ğ•©ğ•¨ğ•£ğ•—ğ•˜"# Input
  ".Â¯Ï€âˆ"                # Numeric
  '0'+â†•10               # Digit
  "_"âˆ¾Ëœâ¥Šalph            # Alphabetic
  "â€¢"âˆ¾(Â¯1â†“"ğ•¨")âˆ¾" "âˆ¾@+9  # Whitespace (or special name prefix in UTF-16)
  "#'""@"               # Preprocessed characters
âŸ©
bFâ€¿b1â€¿b2â€¿bSâ€¿bHâ€¿bGâ€¿bBâ€¿bLâ€¿bOâ€¿bXâ€¿bNâ€¿bDâ€¿bAâ€¿bWâ€¿bPâ†â‹ˆÂ¨ËœâŸœ(0Â»+`)cgl
Mâ†1âŠ¸âŠ‘(0âŠ¸â‰¤âˆ§>)-âŸœâŠ‘   # âˆŠ for an init,length pair ğ•© as above
sepâ†âŠ‘bS
predâ†2+âŠ‘bH
bIâ†bX+â‹ˆâŸœ-5â‹„bRâ†8+âŠ‘bX
Plâ†âˆ¾âŸœ("s"/Ëœ1<â‰ )   # Pluralize
_tmplâ†{âˆ¾ğ•—{ğ•ğ•©}Â¨<ğ•©} # Template
# Convert characters to numbers, mostly the same as tokens
CharCodeâ†charSet{
  FmtChar â† (1<â‰ )â—¶âŸ¨"'"âŠ¸(âˆ¾âˆ¾âŠ£), 30(âŒŠâŸœâ‰ â†‘âŠ¢)âŸœâ·âŸ(<âŸœâ‰ )âŠ¢âŸ©
  ErrUnknownCharsâ†!âŸ¨"Unknown character"âŠ¸Pl,": ",FmtCharâŸ©_tmpl
  Chk â† âŠ¢âŠ£ErrUnknownCharsâˆ˜(â‰ /âŠ£)âŸâ‰¢âŸœ(âŠâŸœğ•—)
  (! "Character set conflict: "âˆ¾gf/Ëœ0âŠ¸âˆ¾)âŸ(âˆ¨Â´) 1(â†“=-âŠ¸â†“)gfâ†(gâ†â‹ğ•—)âŠğ•—
  âŠ¢ Chk gâŠËœ1-Ëœ1âŒˆgfâ‹âŠ¢
}
swap_undoâ†CharCodeâˆŠâŸœmod1âŠ¸/"Ëœâ¼"

vdâ†1+viâ†âŠ‘bN  # Start of identifier numbering (plus dot)
charRoleâ†4âˆ¾Ëœâˆ¾â¥ŠÂ¨ËœâŸœ(â‰ â†‘cglË™)âŸ¨1,2,3,Â¯1,Â¯1,Â¯3,Â¯1â€¿0,Â¯2,0,Â¬/5â€¿6âŸ© # For first vd chars
Tâ†âŒˆ`Ã— â‹„ ITâ†â†•âˆ˜â‰ âŠ¸T â‹„ I1Tâ†(1+â†•âˆ˜â‰ )âŠ¸T
PNâ†1(âˆ¾/âˆ¾Ëœ)(âˆ¨/âŠ£)  # Partitioned-none: partitions where ğ•¨<ğ•© is never 1

# TODO keep track of line number
# TODO keep track of file

# Source to âŸ¨tokens, roles, number of identifiers, literalsâŸ©
# Identifiers then literal tokens are numbered starting at vi
Tokenizeâ†{Systemâ€¿varsâ†ğ•¨
  # Resolve comments and strings
  câ†ğ•©='#'â‹„sâ†/0â€¿0âŠ¸Â«âŠ¸âˆ§smâ†ğ•©='''â‹„dâ†/dmâ†ğ•©='"'
  gâ†â‹qâ†âˆ¾âŸ¨  sâ‹„Â¯1â†“dâ‹„/câŸ© â‹„qâ†©gâŠq                # Open indices
  eâ† gâŠâˆ¾âŸ¨2+sâ‹„ 1â†“dâ‹„-âŸœÂ»âˆ˜âŠâŸœ(0âˆ¾+`c)âŠ¸//(ğ•©âˆŠlf)âˆ¾1âŸ© # Matching close indices
  Seâ†â‰ (>/âŠ¢)âˆ¾âŸœâ‰ {(âŠËœğ•¨)ğ•ŠâŸ(â‰ â—‹(Â¯1âŠ¸âŠ‘))ğ•©âˆ¾ğ•©âŠğ•¨}âŸ¨0âŸ©Ë™  # Find reachable openings
  Stâ†(â‰ ğ•©)â†‘Â·/â¼(Se qâ‹e)âŠ¸âŠ                     # All indices â†’ reached mask
  aâ†St qâ‹„bâ†St eâ‹„fâ†1â‰ `abâ†aâˆ¨b                 # Open/close masks; filter
  {!âŸ¨âŠ‘/ğ•©,"Unclosed quote"âŸ©}âŸ(âˆ¨Â´)(smâˆ¨dm)âˆ§b<f

  # Extract character and string literals
  uâ†fâˆ§ğ•©='@'â‹„ciâ†/uâˆ¨Â»aâˆ§sm
  chrâ†(âŠâŸœğ•©-('@'-@)Ã—âŠâŸœu)ci                   # Characters (indices ci)
  f>â†©qeâ†dmâˆ§Â«aâˆ§â†©dm                           # Quote Escape ""
  strâ†ğ•©âŠ”Ëœ1-Ëœ(siâ†a>Â»qe)(âŠ£+`âŠ¸Ã—â—‹(âˆ¾âŸœ1)<)â‰ `dmâˆ§ab # Strings (indices /si)

  # Extract words: identifiers and numbers
  ieâ†/fâ‹„isâ†ieâ‰ âŠ¸â†‘/1Â»f                        # Token start and end
  is-â†©is(-Ã—âŠâŸœc)ie                           # Comment â†’ ending newline only
  tâ†CharCode ieâŠğ•©
  ndâ†(t=âŠ‘bN)>Â«t M bDâ‹„rrâ†t=bR                # Namespace dot; ğ•£
  wâ†Â»âŠ¸<lâ†rrâˆ¨nd<t M bN(âŠ£â‹ˆ-Ëœ)â—‹âŠ‘bW             # Word chars l, start w
  usâ†t=Â¯1++Â´bAâ‹„syâ†t=âŠ‘bW                     # Underscore, system dot
  {!âŸ¨ğ•©/is,"ğ•£ can only appear as ğ•£, _ğ•£, or _ğ•£_"âŸ©}âŸ(âˆ¨Â´)rrâˆ§((Â»<Â«)us)âˆ¨(Â»âˆ¨Â«)us(<âˆ¨âˆ§âŸœ(Â»âˆ§Â«))syâˆ¨l
  {!âŸ¨is/Ëœusâˆ§w+`âŠ¸âŠ0âˆ¾ğ•©,"Words can't only have underscores"âŸ©}âŸ(âˆ¨Â´)w(/<1(âŠ¢/Â«)(âˆ¨/âŠ£))l>us
  wkâ†(Â¬w/rr)Ã—naâŒŠâˆ˜Ã·Ëœ(âŠ‘bA)-Ëœw/t               # Kind of word from first char
  t-â†©naÃ—lâˆ§tâ‰¥na+âŠ‘bA                          # Case-insensitive
  {!âŸ¨ğ•©/is,"System dot with no name"âŸ©}âŸ(âˆ¨Â´)sy>Â«l
  wâ‰ â†©Â»âŠ¸âˆ¨sy                                  # Start system word at dot
  wiâ†0<wtâ†(2Ã—wkâ‰¥0)(Ã—âŸœÂ¬+âŠ¢)w/sy               # Type: 0 number, 1 system, 2 identifier
  iâ†l>nâ†lâˆ§(+`w)âŠ0âˆ¾Â¬wi                       # Identifier/Number masks
  numâ†is ReadNumsâ—‹(((0âˆ¾us)<âˆ¨âŸœÂ«0âˆ¾n)/0âŠ¸âˆ¾) tÃ—l # Numbers
  irâ†(us/ËœÂ«âŠ¸<i)(âŠ¢+âˆ§âŸœ(2âŠ¸=))wi/wk             # Identifier role
  iuâ†w>nâˆ¨frâ†rrâˆ¨usâˆ§Â«rr                       # Starts of ğ•£ tokens, and non-ğ•£ identifiers
  ifâ†(Â»âŒˆ`)âŠ¸<igâ†(i>usâˆ¨rr)Ã—+`iu               # Identifier groups and first character
  wuâ†ifâˆ¨nâˆ§wâ‹„wsâ†iu/sy                        # Starts of non-ğ•£ words; system identifiers
  {!âŸ¨isâŠËœğ•©/ğ•¨,"Numbers can't start with underscores"âŸ©}âŸ(âˆ¨Â´âŠ¢)âŸœ(ws<(âŠ‘bA)>âŠâŸœt)/if
  idâ†varsâŠ¸âˆ¾âŒ¾âŠ‘(wsâˆ¾2)âŠ”(ig-1)âŠ”tâŠcharSet        # âŸ¨Identifiers, system valuesâŸ©

  # Deduplicate literals and identifiers; other cleanup
  kiâ†((wt/ËœÂ¬w/fr)â’âŠ¸âŠ/wu)âˆ¾(ciâˆ¾/si)âŠ+`Â»f      # Indices in t
  kâ†idâˆ¾numâ€¿chrâ€¿strâ‹„k(âŠ¢>Â¯1Â»âŒˆ`)âŠ¸/Â¨Ëœâ†©jâ†âŠÂ¨k     # IDs j into uniques k
  kâ†©SystemâŒ¾(1âŠ¸âŠ‘)k                           # System value lookup
  wfâ†Â¬lâˆ¨t M bWâ‹„is/Ëœâ†©wfâˆ¨wâ‹„ie/Ëœâ†©wfâˆ¨>âŸœÂ«l       # Index management for...
  tâ†©(varsâ‰ âŠ¸â†“âˆ¾j++`vdÂ»kkâ†â‰ Â¨k)âŒ¾(kiâŠ¸âŠ)t         # Add IDs
  t/Ëœâ†©rrâˆ¨wuâˆ¨wf                              # Remove words/whitespace
  t-â†©t(MÃ—-âŸœâŠ‘)bS                             # Separators are equivalent
  pâ†â‰ `1Â¨sbâ†Â¯1â†“1â†“/1(âˆ¾â‰ âˆ¾Ëœ)t=sep               # Separator group boundaries (excludes leading and trailing)
  ebâ†3â€¿5â€¿7+âŠ‘bB                              # End brackets that allow separators
  skâ†sb/Ëœp>âˆ¨âŸœÂ«(MâŸœbHâˆ¨ebâˆŠËœpâŠ¸+)(sb-p)âŠt        # Keep the first of each group that's not just inside a bracket
  t{is/Ëœâ†©ğ•¨â‹„ie/Ëœâ†©ğ•¨â‹„ğ•¨/ğ•©}Ëœâ†©1Â¨âŒ¾(skâŠ¸âŠ)tâ‰ sep      # Remove the rest
  imâ†(t=bR)âˆ¨t M vdâ‹ˆ+Â´2â†‘kk                   # Identifier (or ğ•£) mask
  râ†irâŒ¾(imâŠ¸/)(vdâŒŠt)âŠcharRoleâˆ¾0              # Role
  t+â†©(âŠ‘bX)((âŠ¢Mâ‹ˆâŸœ5)Ã—5+3âŠ¸+âŠ¸â‰¤)t                # Case-insensitive special names
  t-â†©vi(<+10Ã—=)t                            # Shift . to bX and variables back one
  âŸ¨t,r,k,is,ieâŸ©
}

# ğ•© is a list of tokens that contains the numeric literals, each
# preceded by 0. Return the numbers.
ReadNumsâ†{
  _err_â†{(!/âŸœğ”¾â‹ˆğ”½)âŸ(âˆ¨Â´)}
  ECharsâ†âŸ¨"Letter"âŠ¸Pl," """,âŠâŸœcharSet,""" not allowed in numbers"âŸ©_tmpl
  eâ€¿dâ€¿nâ€¿pâ€¿iâ†=âŸœğ•©Â¨((âŠ‘bA)+-Â´"ea")âˆ¾+âŸœâ†•Â´bN       # Masks for e.Â¯Ï€âˆ
  ECharsâˆ˜(/âŸœğ•©)_err_ğ•¨ (ğ•©=bR)âˆ¨Â¬eâˆ¨ğ•©<âŠ‘bA
  sâ†dâˆ¨câ†eâˆ¨zâ†0=ğ•©â‹„mâ†Â¬nâˆ¨c
  "Negative sign in the middle of a number"_err_ğ•¨ n>Â»c
  "Portion of a number is empty"_err_ğ•¨ (1Â«s)âˆ§nâˆ¨s
  "Ill-formed decimal or exponent use"_err_(s/ğ•) Â¬(0âŠ¸=âˆ¨Â»âŠ¸<)s/ğ•©
  "Ï€ and âˆ must occur alone"_err_ğ•¨ (pâˆ¨i)>1(Â»âˆ§(pâˆ§Â«e)âˆ¨Â«)zâˆ¨n>Â»e
  lâ†(Â¬(âŠ¢-T)Â·+`dâŠ¸<)gâ†(Â«â‰¤(d<yâ†ğ•©â‰ âŠ‘bD)>â—‹I1TÂ¬)âŠ¸âˆ§m# No leading 0s
  laâ†dÃ—(Â»Â¬(âŠ¢-T)+`)âŒ¾âŒ½Â¬gâˆ¨y                    # Adjust dp for dropped 0s after decimal
  kâ€¿dpâ†dÂ¬âŠ¸(/â‹ˆ1âŠ¸Â»âŠ¸/)â—‹((dâˆ¨>âŸœÂ«g)âŠ¸/)l-la        # Length, decimal position
  NNâ†(1Â«0âŠ¸=)/0(0âŠ¸â‰¤Ã—Ã—âŸœ10âŠ¸+)`âŠâŸœ(Â¯1âˆ¾Ï€â€¿1âˆ¾â†•10)   # Digit lookup has âˆ as 1 to avoid âˆÃ—0
  PNâ†NN(Â«âŠ¸>âˆ¨dâŠ¸<)/(ğ•©-1+âŠ‘bN)âŠ¸Ã—                # Evaluate numbers given mask
  vaâ†(âˆ¨Â´k>15)â—¶PNâ€¿{                          # Numeric valuesâ€”mantissas and exponents
    ğ•©âˆ§â†©20â‰¥lâ‹„kâŒŠâ†©20                           # Cap at 20 digits
    ğ•©>â†©fâ†ğ•©âˆ§lâ‰¤(+`Â»âŠ¸<ğ•©)âŠ0âˆ¾teâ†0âŒˆk-15           # Handle trailing â‰¤15 normally
    (1e15Ã—PN f)âŠ¸+âŒ¾((te>0)âŠ¸/) PN ğ•©           # Leading part
  } g
  vâ†vaÃ—1â€¿Â¯1âŠËœ(râ†>âŸœÂ»m)/Â»n                    # Negate if Â¯
  vmâ†c/â—‹(1Â»Â«)z                              # Mask of mantissas in v
  mnâ†vm/vÃ—(r/i)âŠ1â€¿âˆ                         # Mantissa, correcting âˆ
  eeâ†vm/(k-dp)-ËœÂ«vÃ—Â¬vm                      # Power of 10
  aâ†(0âŒˆee)+ee-bâ†eeâŒˆÂ¯308                     # Subnormal handling
  bÃ·âŸœ(10â‹†-)ËœâŒ¾((0>b)âŠ¸/)a 10âŠ¸â‹†âŠ¸Ã—âŒ¾((0â‰ a)âŠ¸/)mn  # mnÃ—10â‹†ee
}

Compileâ†{ ğ•Š:
  defaultsâ†âŸ¨âŸ©â€¿(!âˆ˜"System values not supported"Â¨)â€¿âŸ¨âŸ©â€¿(â†•0)
  primsâ€¿Sysâ€¿varsâ€¿redef â† âˆ¾âŸœ(â‰ â†“defaultsË™) â‹ˆâŸ(4<â‰ )ğ•¨
  âŸ¨tok,role,val,t0,t1âŸ©â†txâ†sysâ€¿vars Tokenize ğ•©
  â€¢Show tok
  â€¢Show role
  â€¢Show val
  â€¢Show t0
  â€¢Show t1
}
