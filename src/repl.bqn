
runtime â†    â€¢Import "./rt.bqn"     
gl      â†    â€¢Import "./glyphs.bqn"
compile â† gl â€¢Import "./c.bqn"
vm      â†    â€¢Import "./vm.bqn"

init_c â† "../lib.so" â€¢FFI ""â€¿"init"
input_c â† "../lib.so" â€¢FFI "i32"â€¿"input"â€¿">&u8:c8"

lfâ†@+10â€¿13
winâ†2

# Lookup table
systableâ†âŸ¨
  "type"â€¿"out"â€¿"show"
  â€¢Type â€¿â€¢Out â€¿â€¢Show 
âŸ©

  # Lookup table
FindSys â† {
  i â† ğ•¨âŠğ•©
  { ! âˆ¾âŸ¨"Unknown system value",(1â‰ â‰ ğ•©)/"s",":"âŸ©âˆ¾" â€¢"âŠ¸âˆ¾Â¨ğ•© }âˆ˜/âŸœğ•©âŸ(âˆ¨Â´) i=â‰ ğ•¨
  i
}
system â† {ğ•¨âŠ¸FindSysâŠğ•©Ë™}Â´systable

PrintLines â† { src ğ•Š n:
  lâ†âˆ¾âŸ¨Â¯1â†“âŒ½n-â†•win,n+â†•winâŸ©
  lâ†©l/Ëœ(lâ‰¥0)âˆ§l<â‰ src
  arrâ† âŠ£â—¶""â€¿" <--"Â¨(n=l)
  â€¢Out lnâ†1â†“âˆ¾lfâŠ¸âˆ¾Â¨(âˆ¾âŸœ"   "âˆ˜â€¢FmtÂ¨l) âˆ¾Â¨ (srcâŠËœl) âˆ¾Â¨ arr
  â€¢Out ""
}


Breakpointâ†{
  ğ•¨ ğ•Š env:
    â€¢Out "Breakpoint!"
    bufâ†' 'Â¨â†•1024
    { ğ•Š:
      râ€¿lâ†Input_c buf
      lâ†©{âŸ¨âŸ©:"";lâ†‘ËœâŠ‘ğ•©}/l=@+0
      env Eval l
      r
    }â€¢_while_ âŠ¢ 1
}

# TODO line /character positions
Catchâ†{ğ•Š: â€¢Out "Error: " âˆ¾ 1âŠ‘â€¢CurrentError @ â‹„ âŸ¨âŸ©}

Eval â†{
       Â· ğ•Š âŸ¨âŸ© : âŸ¨âŸ©
  ;  src ğ•Š ğ•© : ğ•©â‰¡")r" ? 
      â€¢Out "Running program"
      c â† âŸ¨runtime, { System ğ•© }âŸ© Compile src
      {Breakpointâ‡Breakpoint}â€¿2â€¿src VM c
  ; Â· ğ•Š ğ•© :
    #FIXME cleanup
    câ†{ âŸ¨runtime, { System ğ•© }âŸ© Compile ğ•© }âŠCatch ğ•©
    {ğ•Š: {â€¢SHow VM ğ•©}âŠCatch c}âŸ(0â‰ â‰ c) @
}

# f: file
# TODO repl history
Repl â‡ {
  ğ•Š f:
    srcâ†â€¢file.Chars f
    Init_c âŸ¨âŸ©
    bufâ†' 'Â¨â†•1024
    { ğ•Š:
      râ€¿lâ†Input_c buf
      lâ†©{âŸ¨âŸ©:"";lâ†‘ËœâŠ‘ğ•©}/l=@+0
      src Eval l
      r
    }â€¢_while_ âŠ¢ 1
}


#â€¢SHow VM (âŸ¨runtime, { System ğ•© }âŸ©âŠ¸Compile) "1+1"
Repl "../test/foo.bqn"
#GetLine @
#â€¢Show 
