
runtime â†    â€¢Import "./rt.bqn"     
gl      â†    â€¢Import "./glyphs.bqn"
compile â† gl â€¢Import "./c.bqn"
vm      â†    â€¢Import "./vm.bqn"

init_c â† "../lib.so" â€¢FFI ""â€¿"init"
input_c â† "../lib.so" â€¢FFI "i32"â€¿"input"â€¿">&u8:c8"

lfâ†@+10â€¿13
winâ†2

srcâ†@

# Lookup table
systableâ†âŸ¨
  "type"â€¿"out"â€¿"show"
  â€¢Type â€¿â€¢Out â€¿â€¢Show 
âŸ©

  # Lookup table
FindSys â† {
  i â† ğ•¨âŠğ•©
  { ! âˆ¾âŸ¨"Unknown system value",(1â‰ â‰ ğ•©)/"s",":"âŸ©âˆ¾" â€¢"âŠ¸âˆ¾Â¨ğ•© }âˆ˜/âŸœğ•©âŸ(âˆ¨Â´) i=â‰ ğ•¨
  i
}
system â† {ğ•¨âŠ¸FindSysâŠğ•©Ë™}Â´systable

PrintLines â† { src ğ•Š n:
  lâ†âˆ¾âŸ¨Â¯1â†“âŒ½n-â†•win,n+â†•winâŸ©
  lâ†©l/Ëœ(lâ‰¥0)âˆ§l<â‰ src
  arrâ† âŠ£â—¶""â€¿" <--"Â¨(n=l)
  â€¢Out lnâ†1â†“âˆ¾lfâŠ¸âˆ¾Â¨(âˆ¾âŸœ"   "âˆ˜â€¢FmtÂ¨l) âˆ¾Â¨ (srcâŠËœl) âˆ¾Â¨ arr
  â€¢Out ""
}

Breakpointâ†{
  src ğ•Š env:
    â€¢Out "Breakpoint!"
    #PrintLines src
    bufâ†' 'Â¨â†•1024

    â€¢Show env
    câ†âŸ¨runtime, { System ğ•© }, âŸ¨"a", "b"âŸ©âŸ© Compile "b"
    â€¢Show { envâ€¿cbâ€¿0â€¿"a"â€¿1 VM ğ•© }âŸ(0â‰ â‰ c) c
    #{ ğ•Š:
      #râ€¿lâ†Input_c buf
      #â€¢ExitâŸ(Â¬r) r
      #lâ†©{âŸ¨âŸ©:"";lâ†‘ËœâŠ‘ğ•©}/l=@+0

    #}â€¢_while_ 1 1
}

cbâ†{Breakpointâ‡Breakpoint} # callbacks

# TODO line /character positions
Catchâ†{ğ•Š: â€¢Out "Error: " âˆ¾ â€¢Fmt â€¢CurrentError @ â‹„ âŸ¨âŸ©}

Eval â†{
       Â· ğ•Š âŸ¨âŸ© : âŸ¨âŸ©
  ;  env ğ•Š ğ•© : ğ•©â‰¡")r" ? 
      â€¢Out "Running program"
      c â† âŸ¨runtime, { System ğ•© }âŸ© Compile src
      envâ€¿cbâ€¿3â€¿src VM c
  ; env ğ•Š l:
    # TODO merge env
    #FIXME cleanup
    câ†{ âŸ¨runtime, { System ğ•© }âŸ© Compile ğ•© }âŠCatch l
    â€¢Show { envâ€¿cbâ€¿@â€¿l VM ğ•© }âŸ(0â‰ â‰ c) c
}

# f: file
# TODO repl history
Repl â‡ {
  ğ•Š env:
    Init_c âŸ¨âŸ©
    bufâ†' 'Â¨â†•1024
    { ğ•Š:
      râ€¿lâ†Input_c buf # TODO convert utf-8 to Unicode code point
      Ï€
      â€¢ExitâŸ(Â¬r) r
      â€¢SHow l-@
      lâ†©{âŸ¨âŸ©:"";lâ†‘ËœâŠ‘ğ•©}/l=@+0
      env Eval l
    }â€¢_while_ 1 1
}

#â€¢SHow VM (âŸ¨runtime, { System ğ•© }âŸ©âŠ¸Compile) "Ï€"

#envâ†{varsâ‡âŸ¨âŸ©, programâ‡{constsâ‡âŸ¨âŸ© â‹„ blocksâ‡âŸ¨âŸ© â‹„ namesâ‡âŸ¨âŸ©} }
#câ†âŸ¨runtime, { System ğ•© }âŸ© Compile "Ï€"
#â€¢Show envâ€¿âŸ¨âŸ©â€¿âŸ¨âŸ©â€¿"@" VM c
#Init_c âŸ¨âŸ©
#envâ†{varsâ‡âŸ¨âŸ©, programâ‡{constsâ‡âŸ¨âŸ© â‹„ blocksâ‡âŸ¨âŸ© â‹„ namesâ‡âŸ¨âŸ©} }
#env Eval ")r"
#Repl {varsâ‡âŸ¨âŸ©, programâ‡{constsâ‡âŸ¨âŸ© â‹„ blocksâ‡âŸ¨âŸ© â‹„ namesâ‡âŸ¨âŸ©} }
#GetLine @
#â€¢Show 

srcâ†©â€¢file.Chars "../test/foo.bqn"
envâ†{varsâ‡âŸ¨âŸ©, programâ‡{constsâ‡âŸ¨âŸ© â‹„ blocksâ‡âŸ¨âŸ© â‹„ namesâ‡âŸ¨âŸ©} }
#envâ†{varsâ‡âŸ¨"a"âŸ©, programâ‡{constsâ‡âŸ¨âŸ© â‹„ blocksâ‡âŸ¨âŸ© â‹„ namesâ‡âŸ¨âŸ©} }
c â† âŸ¨runtime, { System ğ•© }, âŸ¨âŸ©âŸ© Compile src
# get all vars from env
# add byte code instructions to push
envâ€¿cbâ€¿3â€¿srcâ€¿0 VM c
#â€¢SHow c

#c0 â† âŸ¨runtime, { System ğ•© }, âŸ¨"a"âŸ©âŸ© Compile "a"
#â€¢Show envâ€¿cbâ€¿9â€¿src VM c
## TODO see how variables are referenced at the end of a program
#â€¢SHow c0
#â€¢Out "Running program"
#c â† âŸ¨runtime, { System ğ•© }âŸ© Compile src
#envâ€¿cbâ€¿3â€¿src VM c
