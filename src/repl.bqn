âŸ¨âŸ¨TrimâŸ©â‡strings, nsâŸ© â†â€¢Import "util.bqn"
s â†â€¢Import "s.bqn"
init_c  â† "../lib.so" â€¢FFI ""â€¿"init"
input_c â† "../lib.so" â€¢FFI "a"â€¿"input"

p â† âŸ¨âŸ© â€¢HashMap âŸ¨âŸ© # inspection points

Init_c âŸ¨âŸ©

Listâ†{ 
  ğ•© 
}

Help â† {ğ•© }

Queryâ†{ 
  â€¢Show "query"â€¿ğ•©
}

# HACK
Historyâ†{ ğ•Š:
  kâ†s.idm.Keys @
  vâ†s.idm.Values @
  â€¢Show s.history
  #â€¢Show { iâ€¿f: 20â†‘iâ†“ â€¢FChars "../"âˆ¾f }Â¨kâŠËœvâŠs.history
}

# Repl specific operations
optsâ†â‰[
  ")h"â€¿Help
  ")help"â€¿Help

  ")l"â€¿List
  ")list"â€¿List
  #")r"â€¿R
  # TODO explain
]

systemâ†âŸ¨
  "show"â€¿â€¢Show, 
  "query"â€¿Query, "q"â€¿Query,
  "history"â€¿History, "h"â€¿History
âŸ©

replâ† â€¢ReBqn {replâ‡"loose"â‹„ systemâ‡system}

Eval â† { ğ•Š l:
  nâ†â‰ Â¨âŠopts â‹„ mâ†âˆ¾n{ğ•©â·ğ•¨â†‘l}Â¨âŠopts â‹„ {fâ†1âŠ‘ğ•©â‹„F l}Ë˜m/â‰opts # run opts eg. )l
  {ğ•Š:â€¢Show ReplâŠâ€¢CurrentError l}âŸ((0<â‰ l)âˆ§Â¬âˆ¨Â´m) @ # run repl
}

Runâ‡{ 
  ğ•Š âŸ¨âŸ©: 
    { ğ•Š:
      lâ†Input_c âŸ¨âŸ© 
      â€¢ExitâŸ(l=0) 0 # run cancel
      Eval l
    }â€¢_while_ 1 1 
; ğ•Š ğ•©: EvalÂ¨ğ•©
}

