
runtime â†    â€¢Import "./rt.bqn"     
gl      â†    â€¢Import "./glyphs.bqn"
compile â† gl â€¢Import "./c.bqn"
vm      â†    â€¢Import "./vm.bqn"

init_c â† "../lib.so" â€¢FFI ""â€¿"init"
input_c â† "../lib.so" â€¢FFI "i32"â€¿"input"â€¿">&u8:c8"

lfâ†@+10â€¿13
winâ†2 # window of lines previous and next to current line

srcâ†@

# Lookup table
systableâ†âŸ¨
  "type"â€¿"out"â€¿"show"
  â€¢Type â€¿â€¢Out â€¿â€¢Show 
âŸ©

  # Lookup table
FindSys â† {
  i â† ğ•¨âŠğ•©
  { ! âˆ¾âŸ¨"Unknown system value",(1â‰ â‰ ğ•©)/"s",":"âŸ©âˆ¾" â€¢"âŠ¸âˆ¾Â¨ğ•© }âˆ˜/âŸœğ•©âŸ(âˆ¨Â´) i=â‰ ğ•¨
  i
}
system â† {ğ•¨âŠ¸FindSysâŠğ•©Ë™}Â´systable

PrintLines â† { src ğ•Š n:
  lâ†âˆ¾âŸ¨Â¯1â†“âŒ½n-â†•win,n+â†•winâŸ©
  lâ†©l/Ëœ(lâ‰¥0)âˆ§l<â‰ src
  arrâ† âŠ£â—¶""â€¿" <"Â¨(n=l)
  â€¢Out lnâ†1â†“âˆ¾lfâŠ¸âˆ¾Â¨(âˆ¾âŸœ"   "âˆ˜â€¢FmtÂ¨l) âˆ¾Â¨ (srcâŠËœl) âˆ¾Â¨ arr
  â€¢Out ""
}

Breakpointâ†{
  src ğ•Š envâ€¿n:
    â€¢Out "Breakpoint!"
    src PrintLines n
    bufâ†' 'Â¨â†•1024

    #lâ†"{ğ•Š: 100+ğ•©} 2"
    lâ†"{ğ•Š: 100+ğ•©} a"
    #lâ†"b"
    #â€¢Show env
    # TODO inject variables from all parent envs
    #câ†âŸ¨runtime, { System ğ•© }, âŸ¨"a", "b"âŸ©âŸ© Compile "b"
    câ†âŸ¨runtime, { System ğ•© }, âŸ¨"a", "b"âŸ©âŸ© Compile l
    #câ†âŸ¨runtime, { System ğ•© }, âŸ¨"a", "b"âŸ©âŸ© Compile "a"
    â€¢Show { envâ€¿cbâ€¿0â€¿l VM ğ•© }âŸ(0â‰ â‰ c) c
    #{ ğ•Š:
      #râ€¿lâ†Input_c buf
      #â€¢ExitâŸ(Â¬r) r
      #lâ†©{âŸ¨âŸ©:"";lâ†‘ËœâŠ‘ğ•©}/l=@+0

    #}â€¢_while_ 1 1
}

cbâ†{Breakpointâ‡Breakpoint} # callbacks

# TODO line /character positions
Catchâ†{ğ•Š: â€¢Out "Error: " âˆ¾ â€¢Fmt â€¢CurrentError @ â‹„ âŸ¨âŸ©}

Eval â†{
       Â· ğ•Š âŸ¨âŸ© : âŸ¨âŸ©
  ;  env ğ•Š ğ•© : ğ•©â‰¡")r" ? 
      â€¢Out "Running program"
      c â† âŸ¨runtime, { System ğ•© }âŸ© Compile src
      envâ€¿cbâ€¿3â€¿src VM c
  ; env ğ•Š l:
    # TODO merge env
    #FIXME cleanup
    câ†{ âŸ¨runtime, { System ğ•© }âŸ© Compile ğ•© }âŠCatch l
    â€¢Show { envâ€¿cbâ€¿@â€¿l VM ğ•© }âŸ(0â‰ â‰ c) c

}
# f: file
# TODO repl history
Repl â‡ {
  ğ•Š env:
    Init_c âŸ¨âŸ©
    bufâ†' 'Â¨â†•1024
    { ğ•Š:
      râ€¿lâ†Input_c buf # TODO convert utf-8 to Unicode code point
      â€¢ExitâŸ(Â¬r) r
      # TODO unicode conversion
      lâ†©{âŸ¨âŸ©:"";lâ†‘ËœâŠ‘ğ•©}/l=@+0
      env Eval l
    }â€¢_while_ 1 1
}

srcâ†©â€¢file.Chars "../test/foo.bqn"
c â† âŸ¨runtime, { System ğ•© }, âŸ¨âŸ©âŸ© Compile src
@â€¿cbâ€¿3â€¿src VM c
