dbâ†â€¢Import "d.bqn"
âŸ¨âŸ¨FmtâŸ©â‡stringsâŸ©â†â€¢Import "u.bqn"
lfâ†@+10

# variables to record
audit â‡ âŸ¨âŸ©
filemâ†âŸ¨âŸ©â€¢HashMapâŸ¨âŸ©
bodymâ†âŸ¨âŸ©â€¢HashMapâŸ¨âŸ©
refm â†âŸ¨âŸ©â€¢HashMapâŸ¨âŸ©
valm â†âŸ¨âŸ©â€¢HashMapâŸ¨âŸ©
data â†âŸ¨âŸ©


MakeStack â† {
  s â‡ ğ•©                                                                                               # Stack (a list)
  Push â‡ {sâˆ¾â†©<ğ•© â‹„ ğ•©}                                                                                  # Push a value
  Pop  â‡ {tâ†-ğ•© â‹„ (sâ†“Ëœâ†©t) âŠ¢ âŒ½tâ†‘s}                                                                      # Pop ğ•© values; return as list
  Peek â‡ {ğ•Š: 0=â‰ s ? âŸ¨âŸ©;Â¯1âŠ‘s}                                                                          # Return but don't pop top value
}

ctx â‡ {
  s â‡ MakeStack âŸ¨âŸ©
  Push â‡ { args ğ•Š ğ•©:
    fâ†ğ•©âˆ¾Ëœ(0âŠ¸â‰¢â‰ )â—¶""â€¿(â€¢ns.GetâŸœ"cwd") s.Peek @ 
    Cacheâ†{
      file  â‡ f
      args  â‡ args 
      src   â‡ â€¢file.Chars ğ•© 
      cols  â‡ âˆ¾+`Â¨1Â¨Â¨âŠ”+`src=lf
      lines â‡ 1++`src=lf 
    }
    (filem.SetâŸœCache)âŸ(Â¬âˆ˜filem.Has) f
    s.Push { cwdâ‡â€¢file.Parent f }
    filem.Get f
  }
  Peek â‡ s.Peek
  Pop  â‡ s.Pop
}

bodies â‡ {
  s â‡ MakeStack âŸ¨âŸ©
  Pushâ‡{ file ğ•Š iâ€¿Â·:
    kâ†iâˆ¾âŸ¨fileâŸ©
    Insertâ†{ ğ•Š:
      id â†(bodym.Count @)
      k bodym.Set id
      "body" db.Insert âŸ¨"id"â€¿id, "file"â€¿fileâŸ©
      id
    }

    idâ†(bodym.Has)â—¶Insertâ€¿bodym.Get k
    callâ† "call" db.Insert âŸ¨"body"â€¿id, "depth"â€¿(â‰ s.s)âŸ©
    s.Push {idâ‡id â‹„ fileâ‡file â‹„ callâ‡call}
  }

  Popâ‡{ file ğ•Š startâ€¿end: 
    âŸ¨lines, colsâŸ©â†filem.Get file
    start_lineâ†startâŠ‘lines â‹„ end_lineâ†endâŠ‘lines
    start_colâ†startâŠ‘cols â‹„ end_colâ†endâŠ‘cols
    âŸ¨idâŸ©â†(âŠ‘s.Pop 1) 
    "body_bounds" db.Insert âŸ¨
      "body"â€¿id, 
      "start_line"â€¿start_line, "end_line"â€¿end_line
      "start_col"â€¿start_col,   "end_col"â€¿end_col
    âŸ©
  }
  Peekâ‡s.Peek
}

Refâ†{ bodyâ€¿name ğ•Š fileâ€¿i:
  âŸ¨cols,linesâŸ© â† filem.Get file
  lineâ†iâŠ‘lines â‹„ colâ†iâŠ‘cols
  kâ†bodyâ€¿nameâ€¿lineâ€¿col
  Insertâ†{ ğ•Š:
    idâ†"refs" db.Insert âŸ¨"body"â€¿body, "name"â€¿name, "line"â€¿line, "col"â€¿colâŸ©
    k refm.Set id â‹„ id
  }
  (refm.Has)â—¶Insertâ€¿refm.Get k
}

val â‡ {
  Recâ‡{ nameâ€¿âŸ¨i,Â·âŸ© ğ•Š v:
    âŸ¨id,file,callâŸ©â†bodies.Peek @ 
    refâ† idâ€¿name Ref fileâ€¿i
    Cacheâ†{ğ•Š: nâ†â‰ data â‹„ dataâ†©dataâˆ¾âŸ¨vâŸ© â‹„ (ğ•©âŠ¸valm.Set)âŠ¸âŠ¢n }
    indexâ† (valm.Has)â—¶Cacheâ€¿valm.Get â€¢Hash v
    "vals" db.Insert âŸ¨"ref"â€¿ref, "index"â€¿index, "call"â€¿call, "type"â€¿(â€¢Type v)âŸ©
  }
}
