gl      â†    â€¢Import "./glyphs.bqn"
compile â† gl â€¢Import "./c.bqn"
vm      â†    â€¢Import "./vm.bqn"

lfâ†@+10
runtimeâ‡âŸ¨
 +,-,Ã—,Ã·,â‹†,âˆš,âŒŠ,âŒˆ,|,Â¬,âˆ§,âˆ¨,<,>,â‰ ,=,â‰¤,â‰¥,â‰¡,â‰¢,âŠ£,âŠ¢,â¥Š,âˆ¾,â‰,â‹ˆ,â†‘,â†“,â†•,Â«,Â»,âŒ½,â‰,/,â‹,â’,âŠ,âŠ‘,âŠ,âŠ’,âˆŠ,â·,âŠ”,!,
 Ë™,Ëœ,Ë˜,Â¨,âŒœ,â¼,Â´,Ë,`,
 âˆ˜,â—‹,âŠ¸,âŸœ,âŒ¾,âŠ˜,â—¶,â‰,âš‡,âŸ,âŠ,
âŸ©

fmapâ†âŸ¨âŸ© â€¢HashMap âŸ¨âŸ©
imapâ†âŸ¨âŸ© â€¢HashMap âŸ¨âŸ© #cached imported files

syslistâ†âŸ¨
    "while"â€¿â€¢_while_
    "hash"â€¿â€¢Hash
    "parsefloat"â€¿â€¢ParseFloat
    "ffi"â€¿â€¢FFI
    "out"â€¿â€¢Out
    "exit"â€¿â€¢Exit
    "file"â€¿â€¢file
    "fmt" â€¿â€¢File
    "math"â€¿â€¢math
    "ns"  â€¿â€¢ns
    "show"â€¿â€¢Show
    "bqn"â€¿â€¢Bqn
    "repr"â€¿â€¢Repr
    "type"â€¿â€¢Type
âŸ©

System â†{ ğ•Š args:
  FindSys â† {
    i â† ğ•¨âŠğ•©
    { ! âˆ¾âŸ¨"Unknown system value",(1â‰ â‰ ğ•©)/"s",":"âŸ©âˆ¾" â€¢"âŠ¸âˆ¾Â¨ğ•© }âˆ˜/âŸœğ•©âŸ(âˆ¨Â´) i=â‰ ğ•¨
    i
  }

  { ğ•¨âŠ¸FindSysâŠğ•©Ë™ }Â´âˆ¾<Ë˜â‹ˆË˜â‰>syslistâˆ¾âŸ¨ "import"â€¿Import, "args"â€¿ğ•© âŸ©
}

Fileâ†{ 
  srcâ‡linesâ‡marksâ‡@ 
  file â‡ ğ•©
  src   â†© â€¢file.Chars file
  lines â†© 1++`src=lf 
  marks â†©0âˆ¾âˆ¨Â´Â¨((â‰ src)â†‘"#?"â·src)âŠ”Ëœ+`src=lf
}

ctx â‡ {
  s â‡ âŸ¨âŸ©

  Push â‡ { ğ•Š ğ•©:
    fâ†ğ•©âˆ¾Ëœ(0âŠ¸â‰¢â‰ )â—¶""â€¿(â€¢ns.GetâŸœ"cwd") Peek @
    {ğ•© fmap.Set File f}âŸ(Â¬âˆ˜fmap.Has) f
    sâˆ¾â†©< { cwdâ‡â€¢file.Parent f }
    fmap.Get f
  }

  Peek â‡ {ğ•Š: 0=â‰ s ? âŸ¨âŸ©;Â¯1âŠ‘s}                 # Return but don't pop top value
  Pop  â‡ {tâ†-ğ•© â‹„ (sâ†“Ëœâ†©t) âŠ¢ âŒ½tâ†‘s}             # Pop ğ•© values; return as list
}

Runâ‡Import â‡ {
    ğ•Š ğ•© : âŸ¨âŸ© ğ•Š ğ•©
; Â· ğ•Š ğ•© : imap.Has ğ•© ? imap.Get ğ•©
; args ğ•Š ğ•© : 
    âŸ¨src, file, lines, marksâŸ©â†ctx.Push ğ•©
    c â† âŸ¨runtime, System args, âŸ¨âŸ©âŸ©âŠ¸Compile src
    r â† fileâ€¿linesâ€¿marks VM c
    ğ•© imap.Set r
    ctx.Pop 1 
    r
}

Args â†{ ğ•Š:
  âŸ¨argsâŸ©â†ctx.Peek @
  args
}

