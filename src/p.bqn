gl      â†    â€¢Import "./glyphs.bqn"
compile â† gl â€¢Import "./c.bqn"
vm      â†    â€¢Import "./vm.bqn"
âŸ¨ctxâŸ©   â†    â€¢Import "./s.bqn"

systemâ‡@
runtimeâ‡âŸ¨
 +,-,Ã—,Ã·,â‹†,âˆš,âŒŠ,âŒˆ,|,Â¬,âˆ§,âˆ¨,<,>,â‰ ,=,â‰¤,â‰¥,â‰¡,â‰¢,âŠ£,âŠ¢,â¥Š,âˆ¾,â‰,â‹ˆ,â†‘,â†“,â†•,Â«,Â»,âŒ½,â‰,/,â‹,â’,âŠ,âŠ‘,âŠ,âŠ’,âˆŠ,â·,âŠ”,!,
 Ë™,Ëœ,Ë˜,Â¨,âŒœ,â¼,Â´,Ë,`,
 âˆ˜,â—‹,âŠ¸,âŸœ,âŒ¾,âŠ˜,â—¶,â‰,âš‡,âŸ,âŠ,
âŸ©

import_cacheâ†âŸ¨âŸ© â€¢HashMap âŸ¨âŸ© #cached imported files

Import â‡ {
    ğ•Š ğ•© : âŸ¨âŸ© ğ•Š ğ•©
; Â· ğ•Š ğ•© : import_cache.Has ğ•© ? import_cache.Get ğ•©
; ğ•¨ ğ•Š ğ•© : 
    âŸ¨src, file, linesâŸ©â†ğ•¨ ctx.Push ğ•©
    # FIXME cleanup
    Catch â† ğ•©âŠ¸{ ğ•Š:
      âŸ¨loc, msgâŸ©â† â€¢CurrentError @
      sâ€¿eâ†locâ†©â¥Šloc
      lnâ†linesâŠ‘ËœâŠ‘loc # line number
      mâ†âˆ¨Â´linesâŠ¸=Â¨linesâŠËœloc
      m/â†•â‰ src
      lâ†1â†“m/src
      s+â†•1+e-s
      
      â€¢Out "Error: "âˆ¾msg
      â€¢Out ğ•¨âˆ¾":"âˆ¾â€¢Fmt ln
      â€¢Out l
      â€¢Out âŠ£â—¶" âˆ§"Â¨Â«(m/â†•â‰ src)âˆŠ(s+â†•1+e-s)
      â€¢Exit 1
    }
    #c â† âŸ¨runtime, { System ğ•© }, âŸ¨âŸ©âŸ© Compile src
    c â† (âŸ¨runtime, { System ğ•© }, âŸ¨âŸ©âŸ©âŠ¸Compile)âŠCatch src

    r â† file VM c
    ğ•© import_cache.Set r
    ctx.Pop 1 
    r
}

Args â† { ğ•Š:
  âŸ¨argsâŸ©â†ctx.Peek @
  args
}

FFI â† {
  fâ†ğ•¨ â€¢FFI ğ•©
  { â€¢SHow "record ffi" â‹„  ğ”½ ğ•© }
}

# Lookup table
systableâ† âˆ¾<Ë˜â‹ˆË˜â‰>âŸ¨
     "args"â€¿Args
     "while"â€¿â€¢_while_
     "hash"â€¿â€¢Hash
     "parsefloat"â€¿â€¢ParseFloat
     "ffi"â€¿FFI
     "out"â€¿â€¢Out
    "exit"â€¿â€¢Exit
    "file"â€¿â€¢file
    "fmt" â€¿â€¢Fmt
    "math"â€¿â€¢math
    "ns"  â€¿â€¢ns
    "show"â€¿â€¢Show
    "type"â€¿â€¢Type
  "import"â€¿Import
âŸ©

FindSys â† {
  i â† ğ•¨âŠğ•©
  { ! âˆ¾âŸ¨"Unknown system value",(1â‰ â‰ ğ•©)/"s",":"âŸ©âˆ¾" â€¢"âŠ¸âˆ¾Â¨ğ•© }âˆ˜/âŸœğ•©âŸ(âˆ¨Â´) i=â‰ ğ•¨
  i
}

systemâ†©{ ğ•¨âŠ¸FindSysâŠğ•©Ë™ }Â´systable

