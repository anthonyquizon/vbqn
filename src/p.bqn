PPâ†â€¢Show 
gl      â†    â€¢Import "./glyphs.bqn"
compile â† gl â€¢Import "./c.bqn"
vm      â†    â€¢Import "./vm.bqn"


ansiâ†{
  eâ‡@+27
  cyanâ‡eâˆ¾"[36m"
  whiteâ‡eâˆ¾"[0;37m"
  bold_whiteâ‡eâˆ¾"[1;37m"
  resetâ‡eâˆ¾"[0m"
}

lfâ†@+10
runtimeâ‡âŸ¨
 +,-,Ã—,Ã·,â‹†,âˆš,âŒŠ,âŒˆ,|,Â¬,âˆ§,âˆ¨,<,>,â‰ ,=,â‰¤,â‰¥,â‰¡,â‰¢,âŠ£,âŠ¢,â¥Š,âˆ¾,â‰,â‹ˆ,â†‘,â†“,â†•,Â«,Â»,âŒ½,â‰,/,â‹,â’,âŠ,âŠ‘,âŠ,âŠ’,âˆŠ,â·,âŠ”,!,
 Ë™,Ëœ,Ë˜,Â¨,âŒœ,â¼,Â´,Ë,`,
 âˆ˜,â—‹,âŠ¸,âŸœ,âŒ¾,âŠ˜,â—¶,â‰,âš‡,âŸ,âŠ,
âŸ©

fmapâ†âŸ¨âŸ© â€¢HashMap âŸ¨âŸ©
imapâ†âŸ¨âŸ© â€¢HashMap âŸ¨âŸ© #cached imported files
pmapâ†âŸ¨âŸ© â€¢HashMap âŸ¨âŸ© #cached queries match to filenames

Infoâ†{ 
  kâ†pmap.Keys @
  kâ†©âŠ‘k/Ëœâˆ¨Â´Â¨â·âŸœğ•©Â¨k # take first matching files

  file  â‡ ğ•©
  query â‡ pmap.Get k
  src   â‡ â€¢file.Chars file
  lines â‡ 1++`src=lf 
}

ctx â‡ {
  s â‡ âŸ¨âŸ©

  Push â‡ { ğ•Š ğ•©:
    fâ†ğ•©âˆ¾Ëœ(0âŠ¸â‰¢â‰ )â—¶""â€¿(â€¢ns.GetâŸœ"cwd") Peek @
    {ğ•© fmap.Set Info f}âŸ(Â¬âˆ˜fmap.Has) f
    sâˆ¾â†©< { cwdâ‡â€¢file.Parent f }
    fmap.Get f
  }

  Peek â‡ {ğ•Š: 0=â‰ s ? âŸ¨âŸ©;Â¯1âŠ‘s}                 # Return but don't pop top value
  Pop  â‡ {tâ†-ğ•© â‹„ (sâ†“Ëœâ†©t) âŠ¢ âŒ½tâ†‘s}             # Pop ğ•© values; return as list
}

fileâ‡{
  Linesâ‡{ 
    ğ•© : "/"â‰¤â—‹â‰ â—¶0â€¿(âŠ£â‰¡â‰ âŠ¸â†‘)ğ•© ? â€¢file.Lines ğ•© 
  ; ğ•© : âŸ¨cwdâŸ©â†ctx.Peek @ â‹„ â€¢file.Lines cwdâˆ¾ğ•© 
  } 
  List â‡{ âŸ¨cwdâŸ©â†ctx.Peek @ â‹„ â€¢file.List  cwdâˆ¾ğ•© } 
}

syslistâ†âŸ¨
    "while"â€¿â€¢_while_
    "hash"â€¿â€¢Hash
    "parsefloat"â€¿â€¢ParseFloat
    "ffi"â€¿â€¢FFI
    "out"â€¿â€¢Out
    "exit"â€¿â€¢Exit
    "file"â€¿file
    "flines"â€¿file.Lines
    "math"â€¿â€¢math
    "ns"  â€¿â€¢ns
    "show"â€¿â€¢Show
    "bqn"â€¿â€¢Bqn
    "repr"â€¿â€¢Repr
    "type"â€¿â€¢Type
âŸ©

System â†{ ğ•Š args:
  FindSys â† {
    i â† ğ•¨âŠğ•©
    { ! âˆ¾âŸ¨"Unknown system value",(1â‰ â‰ ğ•©)/"s",":"âŸ©âˆ¾" â€¢"âŠ¸âˆ¾Â¨ğ•© }âˆ˜/âŸœğ•©âŸ(âˆ¨Â´) i=â‰ ğ•¨
    i
  }

  { ğ•¨âŠ¸FindSysâŠğ•©Ë™ }Â´âˆ¾<Ë˜â‹ˆË˜â‰>syslistâˆ¾âŸ¨ "import"â€¿Import, "args"â€¿ğ•© âŸ©
}

Runâ‡Import â‡ {
    ğ•Š ğ•© : âŸ¨âŸ© ğ•Š ğ•©
; Â· ğ•Š ğ•© : imap.Has ğ•© ? imap.Get ğ•©
; args ğ•Š ğ•© : 
    infoâ†ctx.Push ğ•©
    c â† âŸ¨runtime, System args, âŸ¨âŸ©âŸ©âŠ¸Compile info.src
    r â† info VM c

    ğ•© imap.Set r
    ctx.Pop 1 
    r
}

Parseâ†{ ğ•Š p:
  pâ†©{ğ•©/Ëœ0=+`ğ•©='#'}Â¨p # remove comments
  pâ†©p/Ëœ(0<â‰ )Â¨p
  mâ†{1â‰¤+`ğ•©=' '}Â¨p
  locâ†â€¢ParseFloatâŠâŠ£Â¨Â¨":"âŠ¸((âŠ¢-ËœÂ¬Ã—Â·+`1âŠ¸Â»âŠ¸<)âˆ˜âˆŠËœâŠ”âŠ¢)Â¨(Â¬m)/Â¨p
  fileâ†âŠ‘Â¨loc
  zâ†Â¬".bqn"âŠ¸â‰¡Â¨Â¯4â†‘Â¨file
  fileâ†© (âˆ¾âŸœ".bqn"Â¨)âŒ¾(zâŠ¸/) file 
  gâ†âŠfile
  qâ† loc { ğ•¨ ğ•Š âŸ¨p,srcâŸ©: 
    locâ‡ğ•¨
    Runâ‡{ 
      â€¢Out ansi.bold_whiteâˆ¾pâˆ¾ansi.reset
      â€¢Show âŸ¨"", "", ğ•¨âŸ© â€¢BQN âˆ¾âŸ¨"âŸ¨",1â†“âˆ¾','âŠ¸âˆ¾Â¨ğ•©,"âŸ©â† â€¢args",lf,srcâŸ©
    } 
  }Â¨pâ‹ˆÂ¨(m/Â¨p)
  (âŠ‘Â¨gâŠ”file) pmap.SetÂ¨gâŠ”q
}

# === Main ===
{ ğ•Š: â€¢Out "Missing input file" â‹„ â€¢Exit 1 }âŸ(0=â‰ ) â€¢args
Parseâ€¢file.Lines â€¢wdpathâˆ¾"/_p.bqn"
Run â€¢wdpathâˆ¾"/"âˆ¾âŠ‘â€¢args
